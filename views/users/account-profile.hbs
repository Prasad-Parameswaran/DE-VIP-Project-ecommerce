<style>
    .error-message {
        color: red;
        margin-top: 5px;
        font-size: 15px;
        display: block;
    }

    .error-mess {
        color: red;
        margin-top: 5px;
        font-size: 15px;
        display: block;
    }
</style>
<!-- PAGE TITLE
        ================================================== -->
<section class="page-title-section bg-img cover-background" data-background="/user/img/bg/page-title.jpg">
    <div class="container">

        <div class="title-info">
            <h1>My Profile</h1>
        </div>
        <div class="breadcrumbs-info">
            <ul class="ps-0">
                <li><a href="/">Home</a></li>
                <li><a href="/account-profile">My Profile</a></li>
            </ul>
        </div>

    </div>
</section>

<!-- ACCOUNT ORDERS
        ================================================== -->
<section class="md">
    <div class="container">
        <div class="row justify-content-center">
            <!-- left panel -->
            <div class="col-lg-4 col-sm-9 mb-2-3 mb-lg-0">
                <div class="account-pannel">
                    <div class="p-4">
                        <div class="text-center">
                            <div class="pb-3">
                                <img class="img-fluid rounded-circle img-thumbnail" src="/user/img/avatar/t-3.jpg"
                                    style="height: 100px; width: 100px; object-fit: cover;"
                                    xoriginal="/images/{{product.imageUrl.[0].filename}}" alt="...">
                            </div>
                            <h6 class="mb-0 display-28">{{user.name}}</h6>
                            <div class="reward-points">
                                        <i class=" text-primary pe-1"></i> Wallet Amount: â‚¹{{userWallet.wallet}}
                                    </div>
                        </div>
                    </div>
                    <div class="list-group">
                        <a class="list-group-items active" href="/account-profile"><i
                                class="ti-user pe-2"></i>Profile</a>
                        <a class="list-group-items" href="/account-orders"><i class="ti-bag pe-2"></i>Orders<span
                                class="badge badge-pill"></span></a>
                        <a class="list-group-items" href="/account-address"><i
                                class="ti-location-pin pe-2"></i>Addresses</a>
                    </div>
                </div>
            </div>
            <!-- end left panel -->

            <!-- right panel -->
            <div class="col-lg-8">
                <div class="common-block">
                    <div class="inner-title">
                        <h4 class="mb-0">My Profile</h4>
                        <p class="mb-0">Time for a Sharp My profile.</p>
                        <p class="error-message" style="color: brown;"></p>
                    </div>
                    <form method="post" action="/profileEdit" id="signupForm" name="form" onsubmit="return profile()">
                        <div class="row">
                            <div class="col-sm-6">
                                {{#if user}}
                                <div class="form-group">
                                    <label>Your Name</label>
                                    <input type="text" class="form-control" id="nameInput" name="name"
                                        value="{{user.name}}">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Your User Name</label>
                                    <input type="text" class="form-control" id="userName" name="username"
                                        value="{{user.userName}}" placeholder="Your user name here">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Email Address</label>
                                    <input type="email" class="form-control" id="emailInput" name="email"
                                        value="{{user.email}}" placeholder="Your email here">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Contact Number</label>
                                    <input type="text" class="form-control" id="phoneNumber" name="phone"
                                        value="{{user.phoneNumber}}" placeholder="+40-123 456 789">
                                </div>
                            </div>
                            {{!-- <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Enter your password</label>
                                    <input type="password" class="form-control" id="password" name="password"
                                        placeholder="*********">
                                </div>
                            </div> --}}

                        </div>
                        {{/if}}
                        <button type="submit" id="submitbtn" class="butn-style2 mt-4">Update Profile</button>
                    </form>

                </div>
                <div style="padding: 10px;">
                     <div>
                        <h6>change password here.....</h6>
                        <p class="error-mess" style="color: brown;"></p>
                    <p id="error" style="color: brown;"></p>
                    </div>
                    <div style="display: block;" id="oldPas">
                             <label for="oldPassword">Old Password:</label>
                    <input type="password" id="oldPassword" name="oldPassword" style="color: rgb(72, 60, 60);">
                    <br>
                    <button onclick="submit('{{user._id}}')" class="butn-style2 mt-4">submit</button>

                    </div>
                 

                    <div id="formWrapper">
                        <form  id="form" style="display:none;">
                           <div class="col-sm-6">
                                <div class="form-group">
                                    <label>new password</label>
                                    <input type="password" class="form-control" id="newpass" name="newpass"
                                        placeholder="*********">
                                </div>
                            </div>
                            <br>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Re password</label>
                                    <input type="password" class="form-control" id="repass" name="repass"
                                         placeholder="*********">
                                </div>
                            </div>
                        </form>
                           <button onclick="addNewpass()" id="addnewpass" style="display: none;" class="butn-style2 mt-4">Change</button>
                    </div>


                </div>


                <div class="col-lg-12">
                    <div id="accordion" class="accordion-style3">
                        <div class="card">
                            <div class="card-header" id="headingTwo">
                                <h5 class="mb-0">
                                    <button class="btn btn-link collapsed" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        <a>Address Management</a>
                                    </button>
                                </h5>
                            </div>
                            {{#if userAddress }}
                            {{#each userAddress}}
                            <div class="collapse" name="address" id="collapseTwo" aria-labelledby="headingTwo"
                                data-bs-parent="#accordion">
                                <div class="card-body">
                                    <address>
                                        {{ fullname}}, <br>
                                        {{address}},<br>
                                        {{city}} ,
                                        {{state}},
                                        {{country}} <br>
                                        {{pincode}} ,
                                    </address>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6 mb-1">
                                        <a class="butn-style2" href="/getEdit/?index={{@index}}">Edit address</a>

                                    </div>
                                    <div class="col-sm-6">
                                        <a class="butn-style2" href="/deleteAddress/?addressId={{_id}}">Delete
                                            address</a>
                                    </div>
                                </div>
                            </div>
                            {{/each}}
                            {{/if}}
                        </div>
                    </div>
                </div>
                <!-- end right panel -->
            </div>
        </div>
    </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
    integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
    crossorigin="anonymous"></script>
<script>
    function profile() {
        console.log("hiiiiiiiiiiiiiiiiiiiii")
        var firstName = document.getElementById("nameInput").value;
        var lastName = document.getElementById("userName").value;
        var email = document.getElementById("emailInput").value;
        var mobile = document.getElementById("phoneNumber").value;
        var password = document.getElementById("password").value;
        var repassword = document.getElementById("repassword").value;


        var reg = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        var nameerror = /^[A-Za-z]+$/;
        var phoneerror = /^[0-9]{10}$/;
        var passerror = /^(?=.*[A-Z])(?=.*[!@#$%^&*])(?=.{8,})/;
        var error = document.querySelector(".error-message");

        error.innerHTML = "";

        if (firstName === "") {
            error.innerHTML = 'Please enter your name';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (lastName === "") {
            error.innerHTML = 'Please enter your userName';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (nameerror.test(firstName) === false) {
            error.innerHTML = 'Invalid name';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (nameerror.test(lastName) === false) {
            error.innerHTML = 'Invalid userName';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (firstName.length < 4) {
            error.innerHTML = 'Name should contain at least 5 characters';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (lastName.length < 3) {
            error.innerHTML = 'userName should contain at least 3 characters';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (email === "") {
            error.innerHTML = 'Please enter your email id';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (reg.test(email) === false) {
            error.innerHTML = 'Invalid email id';
              setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (phoneerror.test(mobile) === false) {
            error.innerHTML = 'Phone number should contain 10 numbers';
             setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }
        if (passerror.test(password) === false) {
            error.innerHTML = 'Password must contain 8 characters, at least one special character, and at least one uppercase letter';
          setTimeout(function(){ error.innerHTML= "" }, 2000)
            return false;
        }

        return true;
    }
</script>
<script>
  function submit(id) {
    var oldPass = document.getElementById("oldPassword").value;
    var passerror = /^(?=.*[A-Z])(?=.*[!@#$%^&*])(?=.{8,})/;
    var error = document.querySelector(".error-mess");
    error.innerHTML = "";
    if (passerror.test(oldPass) === false) {
      error.innerHTML = 'Password must contain 8 characters, at least one special character, and at least one uppercase letter';
      setTimeout(function(){ error.innerHTML= "" }, 2000);

      return false;
    }

    $.ajax({
      url: "/checkOldpass",
      method: "post",
      data: {
        id: id,
        oldPass: oldPass
      },
      success: (response) => {
        if (response === "success") {
          document.getElementById("form").style.display = "block";
          document.getElementById("oldPas").style.display = "none";
          document.getElementById("addnewpass").style.display = "block";
        } else {
          const x = document.getElementById("error")
          x.innerHTML ="incorrect password"
          setTimeout(function(){ x.innerHTML= "" }, 2000);
        }
      },
      error: () => {
        document.getElementById("error").innerHTML = "Error occurred while processing your request.";
        
      }
    });
  }
</script>
<script>
  function addNewpass(id) {
    var newPass = document.getElementById("newpass").value;
    var rePass = document.getElementById("repass").value;
    var passerror = /^(?=.*[A-Z])(?=.*[!@#$%^&*])(?=.{8,})/;
    var error = document.querySelector(".error-mess");
    error.innerHTML = "";
    if (passerror.test(newPass) === false) {
      error.innerHTML = 'Password must contain 8 characters, at least one special character, and at least one uppercase letter';
      setTimeout(function(){ error.innerHTML= "" }, 2000);

      return false;
    }
        if (passerror.test(rePass) === false) {
      error.innerHTML = 'Password must contain 8 characters, at least one special character, and at least one uppercase letter';
      setTimeout(function(){ error.innerHTML= "" }, 2000);

      return false;
    }
    if(rePass != newPass){
          error.innerHTML = 'Re-password is incorrect';
      setTimeout(function(){ error.innerHTML= "" }, 2000);

      return false;
    }
    else{
      
    $.ajax({
      url: "/newPass",
      method: "post",
      data: {
        newPass: newPass,
        id :id
      },
      success: (response) => {
        if (response === "success") {
                const Toast = Swal.mixin({
                        toast: true,
                        position: 'bottom-right',
                        showConfirmButton: false,
                        timer: 2000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    })

                    Toast.fire({
                        icon: 'success',
                        title: 'New password added :)'
                    })
                    .then(()=>{
                        location.reload()
                    })
         
        } else {
          const x = document.getElementById("error")
          x.innerHTML ="incorrect password"
          setTimeout(function(){ x.innerHTML= "" }, 2000);
        }
      },
      error: () => {
        document.getElementById("error").innerHTML = "Error occurred while processing your request.";
        
      }
    });
    }

  }
</script>
